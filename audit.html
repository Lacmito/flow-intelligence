<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLOW Intelligence - Cost Dashboard</title>
<style>
  :root {
    --bg: #0f172a; --card: #1e293b; --border: #334155; --text: #e2e8f0;
    --muted: #94a3b8; --accent: #38bdf8; --green: #4ade80; --red: #f87171;
    --yellow: #fbbf24; --orange: #fb923c; --purple: #a78bfa; --pink: #f472b6; --cyan: #22d3ee;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 2rem; line-height: 1.6; }
  h1 { font-size: 1.8rem; margin-bottom: 0.3rem; }
  h2 { font-size: 1.2rem; margin: 2rem 0 0.8rem; color: var(--accent); }
  .subtitle { color: var(--muted); margin-bottom: 1.5rem; font-size: 0.88rem; }
  .top-bar { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; }
  .top-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: all 0.15s; }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn-primary { background: rgba(56,189,248,0.15); border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(248,113,113,0.1); border-color: var(--red); color: var(--red); }
  .btn-success { background: rgba(74,222,128,0.1); border-color: var(--green); color: var(--green); }

  /* Summary cards */
  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; margin-bottom: 1.5rem; }
  .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; text-align: center; }
  .summary-card .number { font-size: 1.8rem; font-weight: 700; }
  .summary-card .label { color: var(--muted); font-size: 0.78rem; margin-top: 0.2rem; }

  /* Cost breakdown bar */
  .cost-bar-container { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; margin-bottom: 1.5rem; }
  .cost-bar { display: flex; height: 32px; border-radius: 8px; overflow: hidden; margin: 0.8rem 0; }
  .cost-bar-segment { display: flex; align-items: center; justify-content: center; font-size: 0.68rem; font-weight: 600; min-width: 30px; transition: all 0.3s; cursor: pointer; }
  .cost-bar-segment:hover { filter: brightness(1.2); }
  .cost-legend { display: flex; flex-wrap: wrap; gap: 0.8rem; margin-top: 0.5rem; }
  .cost-legend-item { display: flex; align-items: center; gap: 0.3rem; font-size: 0.78rem; }
  .cost-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* Alerts */
  .alert-box { background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 10px; padding: 1rem 1.2rem; margin-bottom: 1rem; }
  .alert-box h3 { color: var(--red); font-size: 0.95rem; margin-bottom: 0.4rem; }
  .alert-info { background: rgba(56,189,248,0.1); border: 1px solid rgba(56,189,248,0.3); }
  .alert-info h3 { color: var(--accent); }
  .alert-success { background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3); }
  .alert-success h3 { color: var(--green); }
  .alert-warning { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); }
  .alert-warning h3 { color: var(--yellow); }

  /* Filters */
  .filter-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.2rem; margin-bottom: 1.5rem; }
  .filter-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.6rem; align-items: center; }
  .filter-bar label { font-size: 0.8rem; color: var(--muted); font-weight: 600; min-width: 70px; }
  .filter-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.75rem; transition: all 0.15s; user-select: none; }
  .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .filter-btn.active { border-color: var(--accent); background: rgba(56,189,248,0.15); color: var(--accent); }
  .search-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.45rem 0.75rem; color: var(--text); font-size: 0.82rem; width: 220px; outline: none; }
  .search-box:focus { border-color: var(--accent); }
  .count-display { font-size: 0.78rem; color: var(--muted); margin-top: 0.5rem; }

  /* Table */
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  th { background: var(--card); padding: 0.6rem 0.65rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); position: sticky; top: 0; white-space: nowrap; cursor: pointer; z-index: 10; }
  th:hover { color: var(--accent); }
  td { padding: 0.5rem 0.65rem; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:hover td { background: rgba(56, 189, 248, 0.04); }
  tr.hidden { display: none; }

  /* Badges */
  .badge { display: inline-block; padding: 0.1rem 0.45rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
  .badge-active { background: rgba(74, 222, 128, 0.15); color: var(--green); }
  .badge-inactive { background: rgba(248, 113, 113, 0.15); color: var(--red); }
  .badge-ghost { background: rgba(248, 113, 113, 0.25); color: var(--red); border: 1px dashed var(--red); }
  .badge-free { background: rgba(74, 222, 128, 0.1); color: var(--green); border: 1px solid rgba(74,222,128,0.3); }
  .badge-paid { background: rgba(248, 113, 113, 0.1); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .badge-freemium { background: rgba(251, 191, 36, 0.1); color: var(--yellow); border: 1px solid rgba(251,191,36,0.3); }
  .badge-usage { background: rgba(167, 139, 250, 0.1); color: var(--purple); border: 1px solid rgba(167,139,250,0.3); }
  .proj-tag { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin: 1px 1px; }
  .proj-c2b { background: rgba(56,189,248,0.15); color: var(--accent); }
  .proj-cdr { background: rgba(251,146,60,0.15); color: var(--orange); }
  .proj-nat { background: rgba(244,114,182,0.15); color: var(--pink); }
  .proj-met { background: rgba(74,222,128,0.15); color: var(--green); }
  .proj-notif { background: rgba(167,139,250,0.15); color: var(--purple); }
  .proj-pay { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .proj-cons { background: rgba(34,211,238,0.15); color: var(--cyan); }
  .proj-none { background: rgba(248,113,113,0.15); color: var(--red); }
  .action-tag { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 6px; font-size: 0.68rem; font-weight: 600; }
  .action-review { background: rgba(251, 191, 36, 0.2); color: var(--yellow); }
  .action-downgrade { background: rgba(248, 113, 113, 0.2); color: var(--red); }
  .action-keep { background: rgba(74, 222, 128, 0.2); color: var(--green); }
  .action-cancel { background: rgba(248, 113, 113, 0.3); color: var(--red); }
  .action-check { background: rgba(148, 163, 184, 0.2); color: var(--muted); }
  .notes { color: var(--muted); font-size: 0.75rem; }
  .env-var { font-family: 'SF Mono', Monaco, monospace; font-size: 0.7rem; color: var(--cyan); }

  /* Editable fields */
  .editable { cursor: pointer; border-bottom: 1px dashed rgba(56,189,248,0.3); transition: all 0.15s; padding: 1px 3px; border-radius: 4px; }
  .editable:hover { background: rgba(56,189,248,0.1); border-bottom-color: var(--accent); }
  .edit-input { background: var(--bg); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); padding: 2px 6px; font-size: inherit; font-family: inherit; width: 100%; outline: none; }
  .edit-input:focus { box-shadow: 0 0 0 2px rgba(56,189,248,0.2); }
  .edit-select { background: var(--bg); border: 1px solid var(--accent); border-radius: 4px; color: var(--text); padding: 2px 4px; font-size: 0.72rem; outline: none; }

  /* Status indicator */
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
  .status-active { background: var(--green); }
  .status-paused { background: var(--yellow); }
  .status-cancelled { background: var(--red); }
  .status-reviewing { background: var(--accent); }

  /* Feedback saved indicator */
  .save-indicator { position: fixed; bottom: 2rem; right: 2rem; background: var(--green); color: #000; padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.82rem; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
  .save-indicator.show { opacity: 1; }

  .footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--muted); font-size: 0.75rem; }

  /* Billing section */
  .billing-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem; }
  .billing-summary-item { text-align: center; }
  .billing-summary-item .number { font-size: 1.8rem; font-weight: 700; }
  .billing-summary-item .label { font-size: 0.72rem; color: var(--muted); margin-top: 0.2rem; }
  .billing-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
  .billing-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
  .billing-card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem; }
  .billing-card-header h3 { margin: 0; font-size: 0.88rem; }
  .billing-card-total { font-size: 1.3rem; font-weight: 700; }
  .billing-card-client { font-size: 0.72rem; color: var(--muted); margin-bottom: 0.6rem; }
  .billing-badge-billable { background: rgba(74,222,128,0.15); color: var(--green); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-right: 0.5rem; }
  .billing-badge-internal { background: rgba(251,191,36,0.15); color: var(--yellow); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-right: 0.5rem; }
  .billing-svc-row { display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.78rem; }
  .billing-svc-name { color: var(--fg); }
  .billing-svc-cost { font-weight: 600; }
  @media (max-width: 768px) { .billing-summary-grid { grid-template-columns: repeat(2, 1fr); } .billing-grid { grid-template-columns: 1fr; } }

  @media (max-width: 768px) {
    body { padding: 1rem; }
    table { font-size: 0.73rem; }
    td, th { padding: 0.3rem; }
    .search-box { width: 100%; }
    .top-bar { flex-direction: column; }
  }
</style>
</head>
<body>

<div class="top-bar">
  <div>
    <h1>FLOW Intelligence</h1>
    <p class="subtitle">Cost Dashboard &mdash; Scan: 22/02/2026 21:33 &mdash; Click en cualquier costo o nota para editar</p>
  </div>
  <div class="top-actions">
    <button class="btn btn-primary" onclick="rescan()">Re-escanear</button>
    <button class="btn btn-success" onclick="saveSnapshot()">Guardar snapshot mensual</button>
    <button class="btn" onclick="exportFeedback()">Exportar JSON</button>
  </div>
</div>

<!-- Summary -->
<div class="summary-cards" id="summaryCards"></div>

<!-- Cost breakdown -->
<div class="cost-bar-container">
  <div style="display:flex;justify-content:space-between;align-items:baseline;">
    <h2 style="margin:0;font-size:1rem;">Costo mensual estimado</h2>
    <div style="font-size:1.5rem;font-weight:700;" id="totalCost">$0</div>
  </div>
  <div class="cost-bar" id="costBar"></div>
  <div class="cost-legend" id="costLegend"></div>
</div>

<!-- Alerts -->
<div id="alertsContainer"></div>

<!-- Filters -->
<div class="filter-section">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;">
    <span style="font-size:0.88rem;font-weight:600;">Filtros</span>
    <input type="text" class="search-box" id="searchInput" placeholder="Buscar servicio..." oninput="applyFilters()">
  </div>
  <div class="filter-bar">
    <label>Proyecto:</label>
    <div id="projectFilters"></div>
  </div>
  <div class="filter-bar">
    <label>Pago:</label>
    <div id="costFilters"></div>
  </div>
  <div class="filter-bar">
    <label>Acción:</label>
    <div id="actionFilters"></div>
  </div>
  <div class="filter-bar">
    <label>Categoría:</label>
    <div id="catFilters"></div>
  </div>
  <div class="filter-bar">
    <label>Estado:</label>
    <div id="statusFilters"></div>
  </div>
  <div class="count-display" id="countDisplay"></div>
</div>

<!-- Main table -->
<table>
<thead>
<tr>
  <th onclick="sortTable(0)">Servicio</th>
  <th onclick="sortTable(1)">Tipo</th>
  <th>Proyecto</th>
  <th onclick="sortTable(3)">Pago</th>
  <th onclick="sortTable(4)">Costo real/mes</th>
  <th>Estado</th>
  <th>Acción</th>
  <th>Notas / Feedback</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div id="billingSummary" style="margin-top:2rem"></div>
<div id="billingGrid" class="billing-grid"></div>

<div class="footer">
  <p><strong>Tip:</strong> Hacé click en "Costo real/mes", "Estado" o "Notas" para editar. Los cambios se guardan automáticamente en el servidor.</p>
  <p style="margin-top:0.3rem">FLOW Intelligence Cost Dashboard &mdash; <code>python3 server.py</code> para iniciar</p>
</div>

<div class="save-indicator" id="saveIndicator">Guardado</div>

<script>
// Data injected by scan.py
const SCAN_DATA = [{"id": "ghost-stability-ai---stable-diffusion", "name": "Stability AI / Stable Diffusion", "type": "Image generation", "category": "ai", "cost_model": "ghost", "cost_estimate": "US$30/mes", "action": "cancel", "action_label": "CANCELAR YA", "notes": "COBRO FANTASMA. No se usa en ningún proyecto. SDXL se usa via Layer.ai. Cancelar en platform.stability.ai.", "env_var": "", "projects": [], "search": "stable diffusion stability dreamstudio"}, {"id": "APOLLO_API_KEY", "name": "Apollo.io", "type": "Lead generation", "category": "sales", "cost_model": "paid", "cost_estimate": "$49-99/mes", "action": "downgrade", "action_label": "Bajar a free", "notes": "Free: 50 emails/mes. Sin prospección activa, alcanza.", "env_var": "APOLLO_API_KEY", "projects": ["c2b"], "search": "apollo.io apollo_api_key"}, {"id": "CF_R2_ACCESS_KEY_ID", "name": "Cloudflare R2", "type": "Object storage (S3)", "category": "cloud", "cost_model": "freemium", "cost_estimate": "$0 si <10GB", "action": "review", "action_label": "Revisar storage", "notes": "Free: 10GB + 10M req/mes.", "env_var": "CF_R2_ACCESS_KEY_ID", "projects": ["cdr-flow"], "search": "cloudflare r2 cf_r2_access_key_id"}, {"id": "CF_STREAM_API_TOKEN", "name": "Cloudflare Stream", "type": "Video hosting", "category": "cloud", "cost_model": "paid", "cost_estimate": "$100/mes (Creator Bundle + extra storage)", "action": "downgrade", "action_label": "BAJAR PLAN", "notes": "Pagando $100/mes por 20K min pero solo usa 128 min. BAJAR a $5/mes (1K min). Ahorro: $95/mes.", "env_var": "CF_STREAM_API_TOKEN", "projects": ["cdr-flow"], "search": "cloudflare stream cf_stream_api_token"}, {"id": "FAL_KEY", "name": "Fal.ai (FLUX)", "type": "Image generation", "category": "ai", "cost_model": "usage", "cost_estimate": "Variable", "action": "check", "action_label": "Verificar saldo", "notes": "FLUX pro image gen. Pago por uso.", "env_var": "FAL_KEY", "projects": ["metegol"], "search": "fal.ai (flux) fal_key"}, {"id": "GITHUB_BACKUP_TOKEN", "name": "GitHub (backup)", "type": "Code backup", "category": "other", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "Repos privados gratis.", "env_var": "GITHUB_BACKUP_TOKEN", "projects": ["cdr-flow"], "search": "github (backup) github_backup_token"}, {"id": "SMTP_HOST", "name": "Gmail SMTP / API", "type": "Email sending", "category": "comm", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "Incluido en Google Workspace.", "env_var": "SMTP_HOST", "projects": ["cdr-flow"], "search": "gmail smtp / api smtp_host"}, {"id": "GOOGLE_DRIVE_FOLDER_ID", "name": "Google Drive API", "type": "File storage", "category": "google", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "API gratuita.", "env_var": "GOOGLE_DRIVE_FOLDER_ID", "projects": ["natalia"], "search": "google drive api google_drive_folder_id"}, {"id": "GOOGLE_API_KEY", "name": "Google Gemini", "type": "LLM + Image gen", "category": "ai", "cost_model": "freemium", "cost_estimate": "$0 (free tier)", "action": "check", "action_label": "Verificar consumo", "notes": "Free: 60 req/min. Pago solo si excedés cuota.", "env_var": "GOOGLE_API_KEY", "projects": ["metegol"], "search": "google gemini google_api_key"}, {"id": "GOOGLE_CLIENT_ID", "name": "Google OAuth", "type": "Login", "category": "google", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "Autenticación gratuita.", "env_var": "GOOGLE_CLIENT_ID", "projects": ["cdr-flow"], "search": "google oauth google_client_id"}, {"id": "SHEET_ID", "name": "Google Sheets API", "type": "Spreadsheets", "category": "google", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "API gratuita.", "env_var": "SHEET_ID", "projects": ["notif"], "search": "google sheets api sheet_id"}, {"id": "KLING_API_KEY", "name": "Kling AI", "type": "Video generation", "category": "ai", "cost_model": "usage", "cost_estimate": "Variable", "action": "check", "action_label": "Verificar saldo", "notes": "Video gen para branding. Verificar créditos.", "env_var": "KLING_API_KEY", "projects": ["metegol"], "search": "kling ai kling_api_key"}, {"id": "LAYER_API_TOKEN", "name": "Layer.ai", "type": "Custom AI models (SDXL)", "category": "ai", "cost_model": "usage", "cost_estimate": "Variable", "action": "check", "action_label": "Verificar plan", "notes": "Custom model SDXL via Layer.ai.", "env_var": "LAYER_API_TOKEN", "projects": ["metegol"], "search": "layer.ai layer_api_token"}, {"id": "LUCIDLINK_API_KEY", "name": "LucidLink", "type": "Cloud filesystem", "category": "media", "cost_model": "paid", "cost_estimate": "Variable", "action": "keep", "action_label": "Mantener (core)", "notes": "Core para workflow de media.", "env_var": "LUCIDLINK_API_KEY", "projects": ["cdr-flow"], "search": "lucidlink lucidlink_api_key"}, {"id": "MONDAY_API_TOKEN", "name": "Monday.com", "type": "PM + Boards + Webhooks", "category": "pm", "cost_model": "paid", "cost_estimate": "$9-19/seat/mes", "action": "review", "action_label": "Revisar seats", "notes": "Core para workflow. Revisar cuántos seats pagás.", "env_var": "MONDAY_API_TOKEN", "projects": ["cdr-flow"], "search": "monday.com monday_api_token"}, {"id": "OPENAI_API_KEY", "name": "OpenAI", "type": "LLM + Whisper + DALL-E", "category": "ai", "cost_model": "usage", "cost_estimate": "Variable", "action": "review", "action_label": "Revisar billing", "notes": "Verificar si todos los proyectos usan la misma key. Revisar consumo en platform.openai.com.", "env_var": "OPENAI_API_KEY", "projects": ["natalia", "cdr-flow", "metegol", "c2b"], "search": "openai openai_api_key"}, {"id": "REDIS_URL", "name": "Redis", "type": "Cache", "category": "cloud", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "Docker local.", "env_var": "REDIS_URL", "projects": ["c2b"], "search": "redis redis_url"}, {"id": "SMARTLEAD_API_KEY", "name": "Smartlead", "type": "Cold email automation", "category": "sales", "cost_model": "paid", "cost_estimate": "$39-94/mes", "action": "downgrade", "action_label": "Pausar", "notes": "Si no hay campañas de cold email activas, pausar.", "env_var": "SMARTLEAD_API_KEY", "projects": ["c2b"], "search": "smartlead smartlead_api_key"}, {"id": "SUPABASE_URL", "name": "Supabase", "type": "DB + Auth", "category": "cloud", "cost_model": "freemium", "cost_estimate": "$0-25/mes", "action": "check", "action_label": "Verificar plan", "notes": "Free: 500MB DB, 1GB storage.", "env_var": "SUPABASE_URL", "projects": ["c2b"], "search": "supabase supabase_url"}, {"id": "WHATSAPP_API_KEY", "name": "WhatsApp Business API", "type": "Messaging", "category": "comm", "cost_model": "usage", "cost_estimate": "$0 (1K conv free)", "action": "check", "action_label": "Verificar consumo", "notes": "1000 conversaciones/mes gratis.", "env_var": "WHATSAPP_API_KEY", "projects": ["natalia"], "search": "whatsapp business api whatsapp_api_key"}, {"id": "ZEROBOUNCE_API_KEY", "name": "ZeroBounce", "type": "Email verification", "category": "sales", "cost_model": "freemium", "cost_estimate": "$0-16/mes", "action": "downgrade", "action_label": "Bajar a free", "notes": "Free: 100 verificaciones/mes.", "env_var": "ZEROBOUNCE_API_KEY", "projects": ["c2b"], "search": "zerobounce zerobounce_api_key"}, {"id": "extra-cursor-ide", "name": "Cursor IDE", "type": "IDE / AI coding", "category": "other", "cost_model": "paid", "cost_estimate": "$20/mes (Pro)", "action": "keep", "action_label": "Mantener", "notes": "IDE principal para todos los proyectos. Aparece como 'ENSTIL AI' en el extracto bancario. Empresa: Anysphere Inc.", "env_var": "", "projects": ["cdr-flow", "c2b", "natalia", "metegol", "notif", "payroll", "consolidado"], "search": "cursor enstil anysphere ide editor", "enstil": true}, {"id": "extra-google-cloud-(gcp)", "name": "Google Cloud (GCP)", "type": "VM hosting", "category": "cloud", "cost_model": "usage", "cost_estimate": "Variable", "action": "review", "action_label": "Revisar VM", "notes": "VM con CDR-Flow. Verificar si corre 24/7.", "env_var": "", "projects": ["cdr-flow"], "search": "google cloud gcp vm compute", "enstil": false}, {"id": "extra-railway", "name": "Railway", "type": "App hosting", "category": "cloud", "cost_model": "freemium", "cost_estimate": "$0-5+/mes", "action": "check", "action_label": "Verificar plan", "notes": "Deploy webhook contenido-locutora. Si no se usa, pausar.", "env_var": "", "projects": ["natalia"], "search": "railway hosting deploy", "enstil": false}, {"id": "extra-media-shuttle-(signiant)", "name": "Media Shuttle (Signiant)", "type": "File transfer", "category": "media", "cost_model": "paid", "cost_estimate": "Enterprise", "action": "review", "action_label": "Revisar contrato", "notes": "api.mediashuttle.com en UI. Verificar si es contrato propio o de cliente.", "env_var": "", "projects": ["cdr-flow"], "search": "signiant media shuttle file transfer", "enstil": false}, {"id": "extra-apis-tipo-de-cambio", "name": "APIs tipo de cambio", "type": "FX rates", "category": "other", "cost_model": "free", "cost_estimate": "$0", "action": "keep", "action_label": "OK", "notes": "BCRA, DolarAPI.com, mindicador.cl. Públicas sin key.", "env_var": "", "projects": ["consolidado"], "search": "bcra dolar api tipo cambio exchange rate", "enstil": false}];
const PROJECTS = [{"id": "cdr-flow", "name": "CDR-Flow (Traductores Payroll)", "tag_class": "proj-cdr", "tag_label": "CDR-Flow", "description": "Plataforma principal: payroll, proyectos, facturación, estudio, PM inbox, bridge-agent", "path": "/Users/lacmito/CDR Admin/Traductores Payroll", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 81, "npm_count": 29, "pip_count": 0}, {"id": "c2b", "name": "c2b-revenue-engine", "tag_class": "proj-c2b", "tag_label": "c2b", "description": "Motor de ventas/marketing: lead gen, cold email, ads, AI content", "path": "/Users/lacmito/CURSOR - Apps/c2b-revenue-engine", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 14, "npm_count": 10, "pip_count": 17}, {"id": "natalia", "name": "Natalia Rosminati CM-SEO", "tag_class": "proj-nat", "tag_label": "Natalia", "description": "Content gen: WhatsApp audio → Whisper → ChatGPT → Monday + email", "path": "/Users/lacmito/CURSOR - Apps/Natalia Rosminati CM-SEO", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 20, "npm_count": 0, "pip_count": 11}, {"id": "metegol", "name": "Metegol", "tag_class": "proj-met", "tag_label": "Metegol", "description": "ESP32 firmware + branding pipeline AI + bridge serial→Resolume", "path": "/Users/lacmito/Metegol", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 11, "npm_count": 0, "pip_count": 7}, {"id": "notif", "name": "CDR Notificaciones", "tag_class": "proj-notif", "tag_label": "Notif", "description": "Emails de pago, sync Google Sheets, webhook ManyChat", "path": "/Users/lacmito/CDR Admin/CDR notificaaciones", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 1, "npm_count": 0, "pip_count": 7}, {"id": "payroll", "name": "PAYROLL", "tag_class": "proj-pay", "tag_label": "Payroll", "description": "Pipeline payroll: Monday export (XLSX) → OSA payroll", "path": "/Users/lacmito/CDR Admin/PAYROLL", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 0, "npm_count": 0, "pip_count": 0}, {"id": "consolidado", "name": "AAA_Consolidado", "tag_class": "proj-cons", "tag_label": "Consol", "description": "Reportes consolidados y tipos de cambio", "path": "/Users/lacmito/CDR Admin/AAA_Consolidado", "exists": true, "client": "Sin cliente", "billable": false, "env_count": 0, "npm_count": 0, "pip_count": 0}];
const DIFF = {"new_services": [], "removed_services": [], "new_vars": [], "new_projects": [], "removed_projects": []};
const NEW_VARS = [];
const DEFAULT_WEIGHTS = {"OPENAI_API_KEY": {"cdr-flow": 45, "c2b": 15, "natalia": 25, "metegol": 5, "notif": 5, "payroll": 3, "consolidado": 2}, "GOOGLE_API_KEY": {"cdr-flow": 30, "c2b": 20, "natalia": 10, "metegol": 20, "notif": 5, "payroll": 5, "consolidado": 10}, "MONDAY_API_TOKEN": {"cdr-flow": 50, "natalia": 15, "notif": 15, "payroll": 15, "c2b": 5}, "SUPABASE_URL": {"cdr-flow": 70, "c2b": 20, "natalia": 10}, "CF_R2_ACCESS_KEY_ID": {"cdr-flow": 80, "metegol": 20}, "CF_STREAM_API_TOKEN": {"cdr-flow": 100}, "WHATSAPP_API_KEY": {"natalia": 70, "cdr-flow": 30}, "IDEogram_API_KEY": {"metegol": 80, "c2b": 20}, "FAL_KEY": {"metegol": 90, "c2b": 10}, "KLING_API_KEY": {"metegol": 100}, "LAYER_API_TOKEN": {"metegol": 100}, "RUNWAY_API_KEY": {"metegol": 100}, "APOLLO_API_KEY": {"c2b": 100}, "SMARTLEAD_API_KEY": {"c2b": 100}, "ZEROBOUNCE_API_KEY": {"c2b": 100}, "LINKEDIN_AUTOMATION_API_KEY": {"c2b": 100}, "GOOGLE_ADS_DEVELOPER_TOKEN": {"c2b": 100}, "META_ADS_ACCESS_TOKEN": {"c2b": 100}, "LUCIDLINK_API_KEY": {"cdr-flow": 100}, "extra-cursor-ide": {"cdr-flow": 30, "c2b": 20, "natalia": 15, "metegol": 15, "notif": 8, "payroll": 7, "consolidado": 5}, "extra-google-cloud-(gcp)": {"cdr-flow": 85, "notif": 10, "payroll": 5}, "extra-railway": {"natalia": 100}, "extra-media-shuttle-(signiant)": {"cdr-flow": 100}};
const EMBEDDED_FEEDBACK = {"services": {"OPENAI_API_KEY": {"actual_cost": 20, "status": "active", "user_notes": "Verificar si todos los proyectos usan la misma key. Revisar consumo en platform.openai.com. Hay key diferentes para diferentes proyectos."}, "ghost-stability-ai---stable-diffusion": {"user_notes": "COBRO FANTASMA. No se usa en ningún proyecto. SDXL se usa via Layer.ai. Cancelar en platform.stability.ai.\nCancelado", "actual_cost": 0, "status": "cancelled"}, "APOLLO_API_KEY": {"user_notes": "Free Users 1 / 100 credits / mo", "actual_cost": 0, "status": "active"}, "CF_R2_ACCESS_KEY_ID": {"user_notes": "Free: 10GB + 10M req/mes. Fee. 10 million Class B operations + $0.36 / 1 million Class B operations", "actual_cost": 0, "status": "active"}, "CF_STREAM_API_TOKEN": {"user_notes": "Sin free tier real. $50. Creator Bundle Includes 10,000 minutes of video and 500,000 images", "actual_cost": 50, "status": "active"}, "FAL_KEY": {"user_notes": "FLUX pro image gen. Pago por uso. Pay as you go", "actual_cost": 0, "status": "active"}, "GITHUB_BACKUP_TOKEN": {"user_notes": "Repos privados gratis.", "actual_cost": 0, "status": "active"}, "SMTP_HOST": {"user_notes": "Incluido en Google Workspace.", "actual_cost": 0, "status": "active"}, "GOOGLE_DRIVE_FOLDER_ID": {"user_notes": "API gratuita.", "actual_cost": 0, "status": "active"}, "GOOGLE_API_KEY": {"user_notes": "Free: 60 req/min. Pago solo si excedés cuota. Pay as you go", "actual_cost": 0, "status": "active"}, "GOOGLE_CLIENT_ID": {"user_notes": "Autenticación gratuita.", "actual_cost": 0, "status": "active"}, "SHEET_ID": {"user_notes": "API gratuita.", "actual_cost": 0, "status": "active"}, "KLING_API_KEY": {"user_notes": "Video gen para branding. Verificar créditos. Standard. $8.8/month. 660 credits/month", "actual_cost": 9, "status": "active"}, "LAYER_API_TOKEN": {"user_notes": "Custom model SDXL via Layer.ai.", "actual_cost": 0, "status": "active"}, "REDIS_URL": {"user_notes": "Docker local.", "actual_cost": 0, "status": "active"}, "SMARTLEAD_API_KEY": {"user_notes": "Si no hay campañas de cold email activas, pausar. Base. $32/month. 2,000 Contacts.", "actual_cost": 32, "status": "active"}, "SUPABASE_URL": {"user_notes": "Free: 500MB DB, 1GB storage.", "actual_cost": 0, "status": "active"}, "WHATSAPP_API_KEY": {"user_notes": "1000 conversaciones/mes gratis.", "actual_cost": 1, "status": "active"}, "ZEROBOUNCE_API_KEY": {"user_notes": "Free: 100 verificaciones/mes.", "actual_cost": 0, "status": "active"}, "extra-cursor-ide": {"user_notes": "IDE principal para todos los proyectos. Aparece como 'ENSTIL AI' en el extracto bancario. Empresa: Anysphere Inc. Plan Ultrs US200/month", "actual_cost": 200, "status": "active"}, "extra-google-cloud-(gcp)": {"user_notes": "VM con CDR-Flow. Verificar si corre 24/7. $110/month + consumos.", "actual_cost": 110, "status": "active"}, "extra-railway": {"user_notes": "Deploy webhook contenido-locutora. Si no se usa, pausar.", "actual_cost": 0, "status": "active"}, "LUCIDLINK_API_KEY": {"actual_cost": 0, "status": "active", "user_notes": "Core para workflow de media."}, "MONDAY_API_TOKEN": {"actual_cost": 9, "status": "active", "user_notes": "Core para workflow. Revisar cuántos seats pagás."}, "extra-media-shuttle-(signiant)": {"actual_cost": 0, "status": "active", "user_notes": "api.mediashuttle.com en UI. Verificar si es contrato propio o de cliente. Cancelado"}, "extra-apis-tipo-de-cambio": {"actual_cost": 0, "status": "active", "user_notes": "BCRA, DolarAPI.com, mindicador.cl. Públicas sin key."}}, "last_modified": "2026-02-22T21:30:39.070653", "updated_at": {"OPENAI_API_KEY": "2026-02-22T21:29:50.939838", "ghost-stability-ai---stable-diffusion": "2026-02-22T21:28:46.816947", "APOLLO_API_KEY": "2026-02-22T21:28:44.136291", "CF_R2_ACCESS_KEY_ID": "2026-02-22T21:28:40.811995", "CF_STREAM_API_TOKEN": "2026-02-22T21:28:34.109840", "FAL_KEY": "2026-02-22T21:29:00.678697", "GITHUB_BACKUP_TOKEN": "2026-02-22T21:19:15.382764", "SMTP_HOST": "2026-02-22T21:19:15.382764", "GOOGLE_DRIVE_FOLDER_ID": "2026-02-22T21:19:15.382764", "GOOGLE_API_KEY": "2026-02-22T21:29:12.430118", "GOOGLE_CLIENT_ID": "2026-02-22T21:19:15.382764", "SHEET_ID": "2026-02-22T21:19:15.382764", "KLING_API_KEY": "2026-02-22T21:29:25.613011", "LAYER_API_TOKEN": "2026-02-22T21:29:31.508320", "REDIS_URL": "2026-02-22T21:19:15.382764", "SMARTLEAD_API_KEY": "2026-02-22T21:30:10.665234", "SUPABASE_URL": "2026-02-22T21:30:14.997119", "WHATSAPP_API_KEY": "2026-02-22T21:30:17.415559", "ZEROBOUNCE_API_KEY": "2026-02-22T21:30:20.213856", "extra-cursor-ide": "2026-02-22T21:30:26.297500", "extra-google-cloud-(gcp)": "2026-02-22T21:30:33.034706", "extra-railway": "2026-02-22T21:30:36.723827", "LUCIDLINK_API_KEY": "2026-02-22T21:29:36.192077", "MONDAY_API_TOKEN": "2026-02-22T21:29:42.148452", "extra-media-shuttle-(signiant)": "2026-02-22T21:30:39.070643", "extra-apis-tipo-de-cambio": "2026-02-22T21:19:15.382764"}};

const API_BASE = window.location.origin;
let feedback = { services: {} };
let filterState = { proj: 'all', cost: 'all', act: 'all', cat: 'all', status: 'all' };

const CATEGORY_COLORS = {
  ai: '#a78bfa', sales: '#f87171', ads: '#fb923c', pm: '#fbbf24',
  cloud: '#38bdf8', media: '#22d3ee', comm: '#4ade80', google: '#34d399', other: '#94a3b8'
};
const CATEGORY_LABELS = {
  ai: 'AI/LLM', sales: 'Sales', ads: 'Ads', pm: 'PM', cloud: 'Cloud',
  media: 'Media', comm: 'Comunicación', google: 'Google', other: 'Otros'
};
const STATUS_OPTIONS = [
  { value: 'active', label: 'Activo', dot: 'status-active' },
  { value: 'reviewing', label: 'Revisando', dot: 'status-reviewing' },
  { value: 'paused', label: 'Pausado', dot: 'status-paused' },
  { value: 'cancelled', label: 'Cancelado', dot: 'status-cancelled' },
];
const COST_LABELS = { paid: 'Pago', usage: 'Pay-as-you-go', freemium: 'Freemium', free: 'Gratis', ghost: 'Fantasma' };
const COST_BADGE = { paid: 'badge-paid', usage: 'badge-usage', freemium: 'badge-freemium', free: 'badge-free', ghost: 'badge-ghost' };
const ACTION_LABELS = { cancel: 'Cancelar', downgrade: 'Bajar plan', review: 'Revisar', check: 'Verificar', keep: 'Mantener' };

async function init() {
  await loadFeedback();
  renderSummary();
  renderCostBar();
  renderAlerts();
  renderFilters();
  renderTable();
  applyFilters();
}

async function loadFeedback() {
  try {
    const res = await fetch(`${API_BASE}/api/feedback`);
    const ct = res.headers.get('content-type') || '';
    if (res.ok && ct.includes('application/json')) {
      feedback = await res.json();
    } else {
      throw new Error('No JSON API');
    }
  } catch (e) {
    var stored = localStorage.getItem('flow_feedback');
    if (stored) {
      try { feedback = JSON.parse(stored); } catch(e2) {}
    }
    if (typeof EMBEDDED_FEEDBACK !== 'undefined' && EMBEDDED_FEEDBACK.services) {
      var emb = EMBEDDED_FEEDBACK;
      if (!feedback.services) feedback.services = {};
      for (var sid in emb.services) {
        if (!feedback.services[sid]) feedback.services[sid] = {};
        for (var k in emb.services[sid]) {
          if (feedback.services[sid][k] === undefined) {
            feedback.services[sid][k] = emb.services[sid][k];
          }
        }
      }
    }
  }
}

async function saveFeedback(serviceId, data) {
  try {
    const res = await fetch(`${API_BASE}/api/feedback/service`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ service_id: serviceId, ...data }),
    });
    const sct = res.headers.get('content-type') || '';
    if (res.ok && sct.includes('application/json')) {
      if (!feedback.services) feedback.services = {};
      if (!feedback.services[serviceId]) feedback.services[serviceId] = {};
      Object.assign(feedback.services[serviceId], data);
      showSaved();
      renderSummary();
      renderCostBar();
    }
  } catch (e) {
    if (!feedback.services) feedback.services = {};
    if (!feedback.services[serviceId]) feedback.services[serviceId] = {};
    Object.assign(feedback.services[serviceId], data);
    localStorage.setItem('flow_feedback', JSON.stringify(feedback));
    showSaved();
  }
}

function showSaved() {
  const el = document.getElementById('saveIndicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1500);
}

function getSvcFeedback(svcId) {
  return (feedback.services && feedback.services[svcId]) || {};
}

function parseCost(val) {
  if (typeof val === 'number') return val;
  if (!val) return 0;
  const n = parseFloat(String(val).replace(/[^0-9.\-]/g, ''));
  return isNaN(n) ? 0 : n;
}

function getEffectiveCost(svc) {
  const fb = getSvcFeedback(svc.id);
  if (fb.actual_cost !== undefined && fb.actual_cost !== '') return parseCost(fb.actual_cost);
  return parseCost(svc.cost_estimate);
}

function getEffectiveStatus(svc) {
  const fb = getSvcFeedback(svc.id);
  if (fb.status) return fb.status;
  if (svc.cost_model === 'ghost') return 'cancelled';
  if (svc.cost_model === 'free') return 'active';
  return 'reviewing';
}

function projTag(projId) {
  const p = PROJECTS.find(x => x.id === projId);
  if (!p) return '';
  return `<span class="proj-tag ${p.tag_class}">${p.tag_label}</span>`;
}

// RENDER
function renderSummary() {
  let totalCost = 0, paidCount = 0, freeCount = 0, ghostCount = 0;
  SCAN_DATA.forEach(svc => {
    totalCost += getEffectiveCost(svc);
    if (svc.cost_model === 'ghost') ghostCount++;
    else if (['paid', 'usage'].includes(svc.cost_model)) paidCount++;
    else freeCount++;
  });
  document.getElementById('summaryCards').innerHTML = `
    <div class="summary-card"><div class="number" style="color:var(--accent)">${PROJECTS.filter(p => p.exists !== false).length}</div><div class="label">Proyectos</div></div>
    <div class="summary-card"><div class="number" style="color:var(--text)">${SCAN_DATA.length}</div><div class="label">Servicios</div></div>
    <div class="summary-card"><div class="number" style="color:var(--red)">$${totalCost.toFixed(0)}</div><div class="label">Costo mensual</div></div>
    <div class="summary-card"><div class="number" style="color:var(--yellow)">${paidCount}</div><div class="label">Pagos</div></div>
    <div class="summary-card"><div class="number" style="color:var(--green)">${freeCount}</div><div class="label">Gratis</div></div>
    <div class="summary-card"><div class="number" style="color:var(--red)">${ghostCount}</div><div class="label">Fantasma${ghostCount !== 1 ? 's' : ''}</div></div>
  `;
}

function renderCostBar() {
  const byCat = {};
  let total = 0;
  SCAN_DATA.forEach(svc => {
    const cost = getEffectiveCost(svc);
    if (cost > 0) {
      const cat = svc.category || 'other';
      byCat[cat] = (byCat[cat] || 0) + cost;
      total += cost;
    }
  });
  document.getElementById('totalCost').textContent = `$${total.toFixed(0)}/mes`;
  if (total === 0) {
    document.getElementById('costBar').innerHTML = '<div style="flex:1;background:var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:0.78rem;">Ingresá costos reales haciendo click en la columna "Costo real/mes"</div>';
    document.getElementById('costLegend').innerHTML = '';
    return;
  }
  let barHtml = '', legendHtml = '';
  Object.entries(byCat).sort((a, b) => b[1] - a[1]).forEach(([cat, cost]) => {
    const pct = (cost / total * 100).toFixed(1);
    const color = CATEGORY_COLORS[cat] || '#94a3b8';
    barHtml += `<div class="cost-bar-segment" style="flex:${pct};background:${color}" title="${CATEGORY_LABELS[cat] || cat}: $${cost.toFixed(0)}">$${cost.toFixed(0)}</div>`;
    legendHtml += `<div class="cost-legend-item"><div class="cost-legend-dot" style="background:${color}"></div>${CATEGORY_LABELS[cat] || cat}: $${cost.toFixed(0)} (${pct}%)</div>`;
  });
  document.getElementById('costBar').innerHTML = barHtml;
  document.getElementById('costLegend').innerHTML = legendHtml;
}

function renderAlerts() {
  let html = '';
  SCAN_DATA.filter(s => s.cost_model === 'ghost').forEach(s => {
    html += `<div class="alert-box"><h3>COBRO FANTASMA: ${s.name} — ${s.cost_estimate}</h3><p style="font-size:0.85rem">${s.notes}</p></div>`;
  });
  const enstil = SCAN_DATA.find(s => s.enstil);
  if (enstil) {
    html += `<div class="alert-box alert-success"><h3>ACLARADO: "Enstil AI" = Cursor IDE (Anysphere Inc.)</h3><p style="font-size:0.85rem">${enstil.notes}</p></div>`;
  }
  if (DIFF && Object.values(DIFF).some(v => v && v.length)) {
    let items = '';
    if (DIFF.new_services?.length) items += `<li><strong>Servicios nuevos:</strong> ${DIFF.new_services.join(', ')}</li>`;
    if (DIFF.removed_services?.length) items += `<li><strong>Eliminados:</strong> ${DIFF.removed_services.join(', ')}</li>`;
    if (DIFF.new_vars?.length) items += `<li><strong>Vars nuevas:</strong> <code>${DIFF.new_vars.join(', ')}</code></li>`;
    if (items) html += `<div class="alert-box alert-info"><h3>Cambios desde último scan</h3><ul style="font-size:0.85rem;padding-left:1.2rem">${items}</ul></div>`;
  }
  if (NEW_VARS && NEW_VARS.length) {
    html += `<div class="alert-box alert-warning"><h3>Variables .env desconocidas (${NEW_VARS.length})</h3><p style="font-size:0.85rem"><code>${NEW_VARS.join(', ')}</code></p><p style="font-size:0.78rem;color:var(--muted);margin-top:0.3rem">Catalogalas en services_config.json</p></div>`;
  }
  document.getElementById('alertsContainer').innerHTML = html;
}

function renderFilters() {
  const makeBtn = (filter, label, group) => `<button class="filter-btn${filter.endsWith('-all') ? ' active' : ''}" data-filter="${filter}" onclick="toggleFilter(this,'${group}')">${label}</button>`;

  let projHtml = makeBtn('all', 'Todos', 'proj');
  PROJECTS.forEach(p => { projHtml += makeBtn(p.id, `<span class="proj-tag ${p.tag_class}" style="margin:0">${p.tag_label}</span>`, 'proj'); });
  projHtml += makeBtn('none', '<span class="proj-tag proj-none" style="margin:0">Sin proyecto</span>', 'proj');
  document.getElementById('projectFilters').innerHTML = projHtml;

  document.getElementById('costFilters').innerHTML = makeBtn('all', 'Todos', 'cost') +
    Object.entries(COST_LABELS).map(([k, v]) => makeBtn(k, `<span class="badge ${COST_BADGE[k]}" style="margin:0">${v}</span>`, 'cost')).join('');

  document.getElementById('actionFilters').innerHTML = makeBtn('all', 'Todos', 'act') +
    Object.entries(ACTION_LABELS).map(([k, v]) => makeBtn(k, `<span class="action-tag action-${k}" style="margin:0">${v}</span>`, 'act')).join('');

  document.getElementById('catFilters').innerHTML = makeBtn('all', 'Todos', 'cat') +
    Object.entries(CATEGORY_LABELS).map(([k, v]) => makeBtn(k, v, 'cat')).join('');

  document.getElementById('statusFilters').innerHTML = makeBtn('all', 'Todos', 'status') +
    STATUS_OPTIONS.map(s => makeBtn(s.value, `<span class="status-dot ${s.dot}"></span>${s.label}`, 'status')).join('');
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = SCAN_DATA.map(svc => {
    const fb = getSvcFeedback(svc.id);
    const cost = getEffectiveCost(svc);
    const status = getEffectiveStatus(svc);
    const statusOpt = STATUS_OPTIONS.find(s => s.value === status) || STATUS_OPTIONS[0];
    const projIds = svc.projects || [];
    const projData = projIds.length ? projIds.join(' ') : 'none';
    const userNotes = fb.user_notes || '';

    return `<tr data-id="${svc.id}" data-proj="${projData}" data-cost="${svc.cost_model}" data-act="${svc.action}" data-cat="${svc.category}" data-status="${status}" data-search="${svc.search}">
  <td><strong${svc.cost_model === 'ghost' ? ' style="color:var(--red)"' : ''}>${svc.name}</strong>${svc.enstil ? ' <span style="color:var(--muted);font-size:0.68rem">("Enstil AI" en banco)</span>' : ''}${svc.env_var ? `<br><span class="env-var">${svc.env_var}</span>` : ''}</td>
  <td>${svc.type}</td>
  <td>${projIds.length ? projIds.map(p => projTag(p)).join('') : '<span class="proj-tag proj-none">NINGUNO</span>'}</td>
  <td><span class="badge ${COST_BADGE[svc.cost_model] || 'badge-free'}">${COST_LABELS[svc.cost_model] || svc.cost_model}</span></td>
  <td><span class="editable" onclick="editCost(this, '${svc.id}')" data-field="cost">$${cost.toFixed(0)}</span></td>
  <td><span class="editable" onclick="editStatus(this, '${svc.id}')" data-field="status"><span class="status-dot ${statusOpt.dot}"></span>${statusOpt.label}</span></td>
  <td><span class="action-tag action-${svc.action}">${svc.action_label}</span></td>
  <td>
    <div class="notes">${svc.notes}</div>
    <div style="margin-top:4px"><span class="editable" onclick="editNotes(this, '${svc.id}')" data-field="notes" style="font-size:0.75rem;color:var(--accent)">${userNotes || '+ Agregar feedback'}</span></div>
  </td>
</tr>`;
  }).join('');
}

// INLINE EDITING
function editCost(el, svcId) {
  const current = parseCost(el.textContent);
  const input = document.createElement('input');
  input.type = 'number';
  input.className = 'edit-input';
  input.value = current || '';
  input.placeholder = '0';
  input.style.width = '80px';
  el.replaceWith(input);
  input.focus();
  input.select();

  const save = () => {
    const val = parseFloat(input.value) || 0;
    const span = document.createElement('span');
    span.className = 'editable';
    span.setAttribute('onclick', `editCost(this, '${svcId}')`);
    span.setAttribute('data-field', 'cost');
    span.textContent = `$${val.toFixed(0)}`;
    input.replaceWith(span);
    saveFeedback(svcId, { actual_cost: val });
  };
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') save(); if (e.key === 'Escape') { input.replaceWith(el); } });
}

function editStatus(el, svcId) {
  const select = document.createElement('select');
  select.className = 'edit-select';
  STATUS_OPTIONS.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.value;
    opt.textContent = s.label;
    if (s.value === getEffectiveStatus(SCAN_DATA.find(x => x.id === svcId))) opt.selected = true;
    select.appendChild(opt);
  });
  el.replaceWith(select);
  select.focus();

  const save = () => {
    const val = select.value;
    const statusOpt = STATUS_OPTIONS.find(s => s.value === val);
    const span = document.createElement('span');
    span.className = 'editable';
    span.setAttribute('onclick', `editStatus(this, '${svcId}')`);
    span.setAttribute('data-field', 'status');
    span.innerHTML = `<span class="status-dot ${statusOpt.dot}"></span>${statusOpt.label}`;
    select.replaceWith(span);
    const row = span.closest('tr');
    if (row) row.dataset.status = val;
    saveFeedback(svcId, { status: val });
  };
  select.addEventListener('change', save);
  select.addEventListener('blur', save);
}

function editNotes(el, svcId) {
  const fb = getSvcFeedback(svcId);
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'edit-input';
  input.value = fb.user_notes || '';
  input.placeholder = 'Tu feedback aquí...';
  el.replaceWith(input);
  input.focus();

  const save = () => {
    const val = input.value.trim();
    const span = document.createElement('span');
    span.className = 'editable';
    span.setAttribute('onclick', `editNotes(this, '${svcId}')`);
    span.setAttribute('data-field', 'notes');
    span.style.fontSize = '0.75rem';
    span.style.color = val ? 'var(--text)' : 'var(--accent)';
    span.textContent = val || '+ Agregar feedback';
    input.replaceWith(span);
    saveFeedback(svcId, { user_notes: val });
  };
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') save(); if (e.key === 'Escape') { input.replaceWith(el); } });
}

// FILTERS
function toggleFilter(btn, group) {
  const parent = btn.parentElement;
  const filter = btn.dataset.filter;
  if (filter === 'all') {
    parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filterState[group] = 'all';
  } else {
    parent.querySelector('[data-filter="all"]')?.classList.remove('active');
    btn.classList.toggle('active');
    const active = [...parent.querySelectorAll('.filter-btn.active')].map(b => b.dataset.filter).filter(f => f !== 'all');
    if (active.length === 0) {
      parent.querySelector('[data-filter="all"]')?.classList.add('active');
      filterState[group] = 'all';
    } else {
      filterState[group] = active.join(' ');
    }
  }
  applyFilters();
}

function applyFilters() {
  const rows = document.querySelectorAll('#tableBody tr');
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  let visible = 0;

  rows.forEach(row => {
    let show = true;
    if (filterState.proj !== 'all') {
      const rp = row.dataset.proj || '';
      if (!filterState.proj.split(' ').some(p => rp.includes(p))) show = false;
    }
    if (show && filterState.cost !== 'all') {
      if (!filterState.cost.split(' ').includes(row.dataset.cost)) show = false;
    }
    if (show && filterState.act !== 'all') {
      if (!filterState.act.split(' ').includes(row.dataset.act)) show = false;
    }
    if (show && filterState.cat !== 'all') {
      if (!filterState.cat.split(' ').includes(row.dataset.cat)) show = false;
    }
    if (show && filterState.status !== 'all') {
      if (!filterState.status.split(' ').includes(row.dataset.status)) show = false;
    }
    if (show && search) {
      if (!(row.dataset.search + ' ' + row.textContent.toLowerCase()).includes(search)) show = false;
    }
    row.classList.toggle('hidden', !show);
    if (show) visible++;
  });
  document.getElementById('countDisplay').textContent = `Mostrando ${visible} de ${rows.length} servicios`;
}

function sortTable(col) {
  const tbody = document.getElementById('tableBody');
  const rows = [...tbody.querySelectorAll('tr')];
  const dir = tbody.dataset.sortDir === 'asc' ? 'desc' : 'asc';
  tbody.dataset.sortDir = dir;
  rows.sort((a, b) => {
    const at = (a.cells[col]?.textContent || '').trim().toLowerCase();
    const bt = (b.cells[col]?.textContent || '').trim().toLowerCase();
    return dir === 'asc' ? at.localeCompare(bt) : bt.localeCompare(at);
  });
  rows.forEach(r => tbody.appendChild(r));
}

// ACTIONS
async function rescan() {
  const btn = event.target;
  btn.textContent = 'Escaneando...';
  btn.disabled = true;
  try {
    const res = await fetch(`${API_BASE}/api/scan`);
    const data = await res.json();
    if (data.ok) {
      location.reload();
    } else {
      alert('Error en scan: ' + (data.stderr || 'desconocido'));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  } finally {
    btn.textContent = 'Re-escanear';
    btn.disabled = false;
  }
}

async function saveSnapshot() {
  var billing = typeof computeBilling === 'function' ? computeBilling() : {};
  var byProject = {};
  var byCategory = {};
  var total = 0;
  SCAN_DATA.forEach(function(svc) {
    var cost = getEffectiveCost(svc);
    total += cost;
    byCategory[svc.category] = (byCategory[svc.category] || 0) + cost;
  });
  PROJECTS.forEach(function(p) {
    if (billing[p.id]) {
      byProject[p.id] = {
        name: p.name, client: p.client, billable: p.billable,
        total: Math.round(billing[p.id].total * 100) / 100,
        services: billing[p.id].services.map(function(s) {
          return { name: s.name, share: Math.round(s.share * 100) / 100, pct: s.pct };
        })
      };
    }
  });
  var now = new Date();
  var snapshot = {
    date: now.toISOString().slice(0, 7),
    timestamp: now.toISOString(),
    total: Math.round(total * 100) / 100,
    by_project: byProject,
    by_category: byCategory,
    service_count: SCAN_DATA.length,
    feedback_summary: Object.keys(feedback.services || {}).length + ' servicios con feedback'
  };
  try {
    const res = await fetch(`${API_BASE}/api/snapshot`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(snapshot)
    });
    const ct = res.headers.get('content-type') || '';
    if (res.ok && ct.includes('application/json')) {
      const data = await res.json();
      if (data.ok) {
        showSaved();
        alert('Snapshot ' + snapshot.date + ' guardado — Total: $' + snapshot.total + '/mes');
        return;
      }
    }
    throw new Error('No API');
  } catch (e) {
    var history = JSON.parse(localStorage.getItem('flow_snapshots') || '[]');
    history.push(snapshot);
    localStorage.setItem('flow_snapshots', JSON.stringify(history));
    showSaved();
    alert('Snapshot ' + snapshot.date + ' guardado localmente — Total: $' + snapshot.total + '/mes\nBilling por proyecto incluido.');
  }
}

function exportFeedback() {
  const blob = new Blob([JSON.stringify(feedback, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `flow-intelligence-feedback-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ========== BILLING MODULE (injected by scan.py) ==========
// FLOW Intelligence - Billing / Cost Allocation Module

var PROJ_COLORS = {};
PROJECTS.forEach(function(p) {
  var cm = { 'proj-cdr':'#fb923c','proj-c2b':'#38bdf8','proj-nat':'#f472b6','proj-met':'#4ade80','proj-notif':'#a78bfa','proj-pay':'#fbbf24','proj-cons':'#22d3ee' };
  PROJ_COLORS[p.id] = cm[p.tag_class] || '#94a3b8';
});

function getWeights(svcId, projIds) {
  var fb = getSvcFeedback(svcId);
  if (fb.weights && Object.keys(fb.weights).length > 0) return fb.weights;
  if (typeof DEFAULT_WEIGHTS !== 'undefined' && DEFAULT_WEIGHTS[svcId]) return DEFAULT_WEIGHTS[svcId];
  var w = {};
  projIds.forEach(function(pid) { w[pid] = Math.round(100 / projIds.length); });
  return w;
}

function computeBilling() {
  var pc = {};
  PROJECTS.forEach(function(p) { pc[p.id] = { project: p, services: [], total: 0 }; });
  pc['_none'] = { project: { id:'_none', name:'Sin proyecto', tag_label:'N/A', tag_class:'proj-none', client:'-', billable:false }, services: [], total: 0 };

  SCAN_DATA.forEach(function(svc) {
    var cost = getEffectiveCost(svc);
    var pr = svc.projects || [];
    if (pr.length === 0) {
      pc['_none'].services.push({ id: svc.id, name: svc.name, cost: cost, share: cost, pct: 100, category: svc.category });
      pc['_none'].total += cost;
      return;
    }
    var w = getWeights(svc.id, pr);
    var totalW = 0;
    pr.forEach(function(pid) { totalW += (w[pid] || 0); });
    if (totalW === 0) totalW = 100;

    pr.forEach(function(pid) {
      if (!pc[pid]) return;
      var pct = (w[pid] || 0);
      var share = cost * pct / totalW;
      pc[pid].services.push({
        id: svc.id, name: svc.name, cost: cost, share: share,
        pct: Math.round(pct * 100 / totalW), category: svc.category,
        shared: pr.length > 1, projCount: pr.length
      });
      pc[pid].total += share;
    });
  });
  return pc;
}

function renderBilling() {
  var billing = computeBilling();
  var totalBillable = 0, totalInternal = 0;
  PROJECTS.forEach(function(p) {
    var b = billing[p.id];
    if (p.billable) totalBillable += b.total; else totalInternal += b.total;
  });
  var realTotal = SCAN_DATA.reduce(function(s, svc) { return s + getEffectiveCost(svc); }, 0);

  var sumEl = document.getElementById('billingSummary');
  if (!sumEl) return;

  sumEl.innerHTML =
    '<div style="display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap">' +
    '<h2 style="margin:0;font-size:1rem;color:var(--accent)">Resumen de facturaci\u00f3n</h2>' +
    '<span style="font-size:0.78rem;color:var(--muted)">Click en el % para editar la asignaci\u00f3n</span></div>' +
    '<div class="billing-summary-grid">' +
    '<div class="billing-summary-item"><div class="number" style="color:var(--red)">$' + realTotal.toFixed(0) + '</div><div class="label">Gasto total/mes</div></div>' +
    '<div class="billing-summary-item"><div class="number" style="color:var(--green)">$' + totalBillable.toFixed(0) + '</div><div class="label">Facturable a clientes</div></div>' +
    '<div class="billing-summary-item"><div class="number" style="color:var(--yellow)">$' + totalInternal.toFixed(0) + '</div><div class="label">Costo interno</div></div>' +
    '<div class="billing-summary-item"><div class="number" style="color:var(--muted)">$' + billing['_none'].total.toFixed(0) + '</div><div class="label">Sin asignar</div></div></div>';

  var projectOrder = PROJECTS.filter(function(p) { return billing[p.id].services.length > 0; })
    .sort(function(a, b) { return billing[b.id].total - billing[a.id].total; });

  var gh = '';
  projectOrder.forEach(function(p) {
    var b = billing[p.id];
    var color = PROJ_COLORS[p.id] || '#94a3b8';
    var bt = p.billable
      ? '<span class="billing-badge-billable">FACTURABLE</span>'
      : '<span class="billing-badge-internal">INTERNO</span>';

    var sh = b.services.sort(function(a, bb) { return bb.share - a.share; }).map(function(s) {
      var pctHtml;
      if (s.shared) {
        pctHtml = '<span class="editable" onclick="editWeight(\'' + s.id + '\',\'' + p.id + '\')" ' +
          'style="color:var(--accent);font-size:0.68rem;cursor:pointer;border-bottom:1px dashed rgba(56,189,248,0.4)" ' +
          'title="Click para editar asignaci\u00f3n">' + s.pct + '%</span>';
      } else {
        pctHtml = '<span style="font-size:0.68rem;color:var(--muted)">100%</span>';
      }
      var catDot = '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' +
        (CATEGORY_COLORS[s.category] || '#94a3b8') + ';margin-right:4px"></span>';
      return '<div class="billing-svc-row">' +
        '<span class="billing-svc-name">' + catDot + s.name + ' ' + pctHtml + '</span>' +
        '<span class="billing-svc-cost" style="color:' + color + '">$' + s.share.toFixed(0) + '</span></div>';
    }).join('');

    gh += '<div class="billing-card">' +
      '<div class="billing-card-header">' +
      '<h3><span class="proj-tag ' + p.tag_class + '">' + p.tag_label + '</span> ' + p.name + '</h3>' +
      '<div class="billing-card-total" style="color:' + color + '">$' + b.total.toFixed(0) + '/mes</div></div>' +
      '<div class="billing-card-client">' + bt + ' Cliente: <strong>' + p.client + '</strong></div>' +
      sh + '</div>';
  });

  if (billing['_none'].services.length > 0) {
    var ns = billing['_none'].services.sort(function(a, b) { return b.cost - a.cost; }).map(function(s) {
      return '<div class="billing-svc-row">' +
        '<span class="billing-svc-name">' + s.name + '</span>' +
        '<span class="billing-svc-cost" style="color:var(--red)">$' + s.cost.toFixed(0) + '</span></div>';
    }).join('');
    gh += '<div class="billing-card" style="border-color:rgba(248,113,113,0.3)">' +
      '<div class="billing-card-header"><h3 style="color:var(--red)">Sin proyecto</h3>' +
      '<div class="billing-card-total" style="color:var(--red)">$' + billing['_none'].total.toFixed(0) + '</div></div>' +
      '<div class="billing-card-client"><span class="billing-badge-internal">REVISAR</span></div>' +
      ns + '</div>';
  }

  document.getElementById('billingGrid').innerHTML = gh;
}

function editWeight(svcId, projId) {
  var svc = SCAN_DATA.find(function(s) { return s.id === svcId; });
  if (!svc) return;
  var pr = svc.projects || [];
  var w = getWeights(svcId, pr);

  var lines = pr.map(function(pid) {
    var p = PROJECTS.find(function(x) { return x.id === pid; });
    return (p ? p.tag_label : pid) + ': ' + (w[pid] || 0) + '%';
  }).join('\n');

  var projLabels = pr.map(function(pid) {
    var p = PROJECTS.find(function(x) { return x.id === pid; });
    return p ? p.tag_label : pid;
  }).join(', ');

  var input = prompt(
    'Asignaci\u00f3n de costo para "' + svc.name + '"\n' +
    '(costo total: $' + getEffectiveCost(svc).toFixed(0) + '/mes)\n\n' +
    lines + '\n\n' +
    'Ingres\u00e1 los nuevos % separados por coma\n(' + projLabels + '):'
  );
  if (!input) return;

  var vals = input.split(',').map(function(v) { return parseInt(v.trim()) || 0; });
  if (vals.length !== pr.length) {
    alert('Necesit\u00e1s ' + pr.length + ' valores, uno por proyecto (' + projLabels + ')');
    return;
  }

  var newW = {};
  pr.forEach(function(pid, i) { newW[pid] = vals[i]; });
  saveFeedback(svcId, { weights: newW });
  setTimeout(renderBilling, 300);
}


// ========== INIT ==========
async function init() {
  await loadFeedback();
  renderSummary();
  renderCostBar();
  renderAlerts();
  renderFilters();
  renderTable();
  if (typeof renderBilling === 'function') renderBilling();
  applyFilters();
}

var _origSaveFn = saveFeedback;
saveFeedback = async function(serviceId, data) {
  await _origSaveFn(serviceId, data);
  renderSummary();
  renderCostBar();
  renderTable();
  if (typeof renderBilling === 'function') renderBilling();
  applyFilters();
};

init();
</script>
</body>
</html>
